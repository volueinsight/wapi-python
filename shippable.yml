#
# CI of wapi-python with Shippable
#

language: python

python:
  - 2.7
  - 3.6
  - 3.7

env:
  global:
    - secure: jdWSf9ZfCbs6IbktwcfsE/V/oVXdtaT6bGVyDAroLC4lhIknPYD/0+N2oMSllq5jvmsYACLzyxpFVac8iW4CNeFi/thkz1xTMYuK8E3SfHbzoOD0+KjMffvh2ARIGPskgL69/jeWs1GL+Dx/Om4dnp8laoFPjYevC6uMA6VjGKmyRVYvkmhLrEKNt/7kPzb+l67WdAM5PHApArAWRSjlmPNH8CT+1qjoDJlKPK+Jnu3cxpsE7SC7OqEgYnmaZvDJMbGKsJDfYnjs8Y38cPoErf5DBB8wVx7TM8bssSRudR0cLFm9+ofEdvQ824lHmFHgWcJ8ERZ1aw6xQeNzECPZbw==
    - secure: QyzIuauz4bUPJaw6QnoUq2aAsmWfvlwrocrP3zmd2BkDZmhuT+rtDSjYL7Qp3e4yLg/6suHMJSRUD+lgBqnDDvGalvvtkN2XfqIigOAt18Haz3p843DxGPmo5nH2u9jPhyEgFgs4YsIwMvI2jKTxadtGjwUL4cDF87a0ZTOCuKNKCydXfIbkYQgCazlwpk86Qyt7ykrld1l2AyAjoZVkhnnbLUFQCgC0vBuV1JUo2C48yyRAQ29jAQlJ9BCs7PdaRaHabIclZO85fcBxtWa1nqTtcMPfz9HpqGgsiTEiDb+1JfLRpG2w3oN9RELhSh7RJgqKJgL9TiUznGr/UVgbAQ==

build:
  pre_ci_boot:
    image_name: drydock/u16pytall
    image_tag: v6.5.4
    pull: true

  ci:
    - mkdir -p shippable/testresults
    - mkdir -p shippable/codecoverage
    - shippable_retry pip install -r requirements.txt
    - shippable_retry pip install -r test-requirements.txt
    - python -m pytest --junit-xml=shippable/testresults/junit.xml
    - python -m pytest --cov=wapi --cov-report=xml:shippable/codecoverage/coverage.xml
    - if [ "$SHIPPABLE_PYTHON_VERSION" == "3.7" ]; then
      apt-get install pylint;
      shippable_retry wget https://sonarsource.bintray.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-2.9.0.670.zip;
      unzip sonar-scanner-cli-2.9.0.670.zip;
      fi
    - >
      if [ "$IS_PULL_REQUEST" == "false" -a "$SHIPPABLE_PYTHON_VERSION" == "3.7" ] &&
      [ "$BRANCH" == "master" -o "$BRANCH" == "development" -o "$BRANCH" == "shippable" ]; then
      ./sonar-scanner-2.9.0.670/bin/sonar-scanner
      -Dsonar.sources=wapi
      -Dsonar.host.url=https://sonar.dev.wattsight.com
      -Dsonar.login=$SONAR_TOKEN
      -Dsonar.python.coverage.reportPath=shippable/codecoverage/coverage.xml
      -Dsonar.projectName="Wapi-python :: $BRANCH"
      -Dsonar.projectKey="wapi-python:$BRANCH";
      fi
    - >
      if [ "$IS_PULL_REQUEST" == "true" -a "$SHIPPABLE_PYTHON_VERSION" == "3.7" ]; then
      ./sonar-scanner-2.9.0.670/bin/sonar-scanner
      -Dsonar.analysis.mode=preview
      -Dsonar.sources=wapi
      -Dsonar.host.url=https://sonar.dev.wattsight.com
      -Dsonar.login=$SONAR_TOKEN
      -Dsonar.github.oauth=$GITHUB_TRAVIS_TOKEN
      -Dsonar.github.pullRequest=$PULL_REQUEST
      -Dsonar.github.repository=wattsight/wapi-python
      -Dsonar.python.coverage.reportPath=shippable/codecoverage/coverage.xml
      -Dsonar.projectName="Wapi-python :: $BRANCH"
      -Dsonar.projectKey="wapi-python:$BRANCH";
      fi


#
# Todo: Add release to github + pypi when updating master branch
#
